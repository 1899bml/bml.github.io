<!DOCTYPE html>
<html lang="pt">
<head>
  <meta charset="UTF-8">
  <title>Lista de Sócios</title>
  <style>
    body { font-family: 'Segoe UI', sans-serif; background: #f0f2f5; padding: 2em; }
    h1, .stats, .filters, .top-bar, .back-link { text-align: center; margin-bottom: 1em; }
    .top-bar input { padding: 0.5em; width: 250px; margin-right: 1em; }
    .top-bar button { padding: 0.5em 1em; margin: 0.3em; border: none; border-radius: 4px; cursor: pointer; background: #0078d4; color: white; }
    .filters button { background: #ddd; border: none; padding: 0.5em 1em; margin: 0 0.3em; border-radius: 4px; cursor: pointer; }
    .filters .active { background: #0078d4; color: white; }
    .socio-list { display: grid; grid-template-columns: repeat(auto-fit, minmax(280px, 1fr)); gap: 1em; }
    .socio-card { background: white; padding: 1em; border-radius: 6px; box-shadow: 0 0 5px rgba(0,0,0,0.05); position: relative; }
    .card-buttons { margin-top: 1em; }
    .card-buttons button { margin: 0.2em; padding: 0.4em 0.8em; font-size: 0.9em; }
    .modal { position: fixed; top: 0; left: 0; width: 100%; height: 100%; background: rgba(0,0,0,0.5); display: none; justify-content: center; align-items: center; }
    .modal-content { background: white; padding: 2em; border-radius: 8px; width: 300px; }
    .modal-content input, .modal-content select { width: 100%; margin-bottom: 1em; padding: 0.5em; }
  </style>
</head>
<body>

  <h1>Lista de Sócios</h1>

  <div class="top-bar">
    <input type="text" id="pesquisa" placeholder="Pesquisar por nome ou email" oninput="filtrarPesquisa()" />
    <button onclick="exportarCSV()">Exportar CSV</button>
    <button onclick="ordenarPorNome()">Ordenar por Nome</button>
    <button onclick="ordenarPorData()">Ordenar por Data</button>
    <button onclick="repor()">Limpar Filtros</button>
  </div>

  <div class="filters">
    <button class="active" onclick="filtrarCategoria('Todos')">Todos</button>
    <button onclick="filtrarCategoria('Ativo')">Ativo</button>
    <button onclick="filtrarCategoria('Inativo')">Inativo</button>
    <button onclick="filtrarCategoria('Pendente')">Pendente</button>
  </div>

  <div class="stats" id="contadores"></div>
  <div class="socio-list" id="lista"></div>
  <a class="back-link" href="index.html">← Voltar ao painel</a>

  <div class="modal" id="modal">
    <div class="modal-content">
      <h3>Editar Sócio</h3>
      <input id="editNome" placeholder="Nome" />
      <input id="editEmail" placeholder="Email" />
      <input id="editTelefone" placeholder="Telefone" />
      <select id="editCategoria">
        <option>Ativo</option>
        <option>Inativo</option>
        <option>Pendente</option>
      </select>
      <input id="editData" type="date" />
      <input id="editEndereco" placeholder="Endereço" />
      <button onclick="guardarEdicao()">Guardar</button>
      <button onclick="fecharModal()">Cancelar</button>
    </div>
  </div>

  <script>
    const sheetID = '1v5Zf8fxY-cIq8xw0G8hoeHDRUAXzpDmGEj16qf4_LhQ';
    const apiKey = 'AIzaSyBbb8_6fOmFweuLmla-mQz3MolkQqLPk1w';
    const webAppURL = 'https://script.google.com/macros/s/AKfycbzDQbfla8fmpYAB6p0xSEDgd7GxR-mD0yNY0zBLz9xPAxNwAOsjYrplGHVOnmk3PzMiMw/exec';
    const range = 'Folha1!A2:F';
    let todos = [];
    let visiveis = [];
    let linhaAtual = null;

    fetch(`https://sheets.googleapis.com/v4/spreadsheets/${sheetID}/values/${range}?key=${apiKey}`)
      .then(res => res.json())
      .then(data => {
        todos = data.values.map((linha, i) => [...linha, i + 2]); // Adiciona número da linha
        visiveis = [...todos];
        mostrar(visiveis);
        atualizarContadores(todos);
      });

    function mostrar(lista) {
      const container = document.getElementById("lista");
      container.innerHTML = "";
      lista.forEach(linha => {
        const [nome, email, telefone, categoria, data, endereco, linhaNum] = linha;
        const card = document.createElement("div");
        card.className = "socio-card";
        card.innerHTML = `
          <strong>${nome}</strong><br>
          ${email ? `📧 ${email}<br>` : ""}
          ${telefone ? `📞 ${telefone}<br>` : ""}
          ${categoria ? `📌 ${categoria}<br>` : ""}
          ${data ? `📅 ${data}<br>` : ""}
          ${endereco ? `🏠 ${endereco}<br>` : ""}
          <div class="card-buttons">
            <button onclick="editar(${linhaNum}, '${nome}', '${email}', '${telefone}', '${categoria}', '${data}', '${endereco}')">✏️ Editar</button>
            <button onclick="apagar(${linhaNum})">🗑️ Apagar</button>
          </div>
        `;
        container.appendChild(card);
      });
    }

    function editar(linha, nome, email, telefone, categoria, data, endereco) {
      linhaAtual = linha;
      document.getElementById("editNome").value = nome;
      document.getElementById("editEmail").value = email;
      document.getElementById("editTelefone").value = telefone;
      document.getElementById("editCategoria").value = categoria;
      document.getElementById("editData").value = data;
      document.getElementById("editEndereco").value = endereco;
      document.getElementById("modal").style.display = "flex";
    }

    function fecharModal() {
      document.getElementById("modal").style.display = "none";
    }

    function guardarEdicao() {
      const dados = {
        acao: "editar",
        linha: linhaAtual,
        nome: document.getElementById("editNome").value,
        email: document.getElementById("editEmail").value,
        telefone: document.getElementById("editTelefone").value,
        categoria: document.getElementById("editCategoria").value,
        data: document.getElementById("editData").value,
        endereco: document.getElementById("editEndereco").value
      };
      fetch(webAppURL, {
        method: "POST",
        body: new URLSearchParams(dados)
      }).then(() => location.reload());
    }

    function apagar(linha) {
      if (!confirm("Tem a certeza que quer apagar este sócio?")) return;
      fetch(webAppURL, {
        method: "POST",
        body: new URLSearchParams({ acao: "apagar", linha })
      }).then(() => location.reload());
    }

    function filtrarCategoria(cat) {
      document.querySelectorAll(".filters button").forEach(btn => btn.classList.remove("active"));
      document.querySelector(`.filters button[onclick="filtrarCategoria('${cat}')"]`).classList.add("active");
      visiveis = cat === "Todos" ? [...todos] : todos.filter(linha => linha[3] === cat);
      mostrar(visiveis);
    }

    function filtrarPesquisa() {
      const termo = document.getElementById("pesquisa").value.toLowerCase();
      const filtrados = visiveis.filter(linha =>
        linha[0]?.toLowerCase().includes(termo) || linha[1]?.toLowerCase().includes(termo)
      );
      mostrar(filtrados);
    }
    }

    function filtrarPesquisa() {
      const termo = document.getElementById("pesquisa").value.toLowerCase();
      const filtrados = visiveis.filter(linha =>
        linha[0]?.toLowerCase().includes(termo) || linha[1]?.toLowerCase().includes(termo)
      );
      mostrar(filtrados);
    }

    function ordenarPorNome() {
      visiveis.sort((a, b) => a[0].localeCompare(b[0]));
      mostrar(visiveis);
    }

    function ordenarPorData() {
      visiveis.sort((a, b) => new Date(b[4]) - new Date(a[4]));
      mostrar(visiveis);
    }

    function exportarCSV() {
      let csv = "Nome,Email,Telefone,Categoria,Data,Endereço\n";
      visiveis.forEach(linha => {
        csv += linha.slice(0, 6).map(c => `"${c}"`).join(",") + "\n";
      });
      const blob = new Blob([csv], { type: "text/csv" });
      const link = document.createElement("a");
      link.href = URL.createObjectURL(blob);
      link.download = "socios.csv";
      link.click();
    }

    function repor() {
      document.getElementById("pesquisa").value = "";
      visiveis = [...todos];
      mostrar(visiveis);
      document.querySelectorAll(".filters button").forEach(btn => btn.classList.remove("active"));
      document.querySelector(`.filters button[onclick="filtrarCategoria('Todos')"]`).classList.add("active");
    }

    function atualizarContadores(lista) {
      const total = lista.length;
      const ativos = lista.filter(l => l[3] === "Ativo").length;
      const inativos = lista.filter(l => l[3] === "Inativo").length;
      const pendentes = lista.filter(l => l[3] === "Pendente").length;
      document.getElementById("contadores").innerText =
        `Total: ${total} | Ativos: ${ativos} | Inativos: ${inativos} | Pendentes: ${pendentes}`;
    }
  </script>
</body>
</html>


